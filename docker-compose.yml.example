version: '2'
services:
    redis:
        image: redis:alpine
        container_name: qualibet-redis
    mysql:
        image: mysql:5.7
        volumes:
            - /home/stephen/docker-cache/mysql:/var/lib/mysql
        container_name: qualibet-mysql
        ports:
         - "9911:3306"
        environment:
            MYSQL_ALLOW_EMPTY_PASSWORD: 1
            MYSQL_USER: root
            MYSQL_PASSWORD: root
    webserver:
        image: nginx:alpine
        container_name: qualibet-webserver
        volumes:
            - /home/stephen/qualibet:/var/www/html/qualibet
            - ./nginx/api.conf:/etc/nginx/conf.d/api.conf
            - ./nginx/worker.conf:/etc/nginx/conf.d/worker.conf
            - ./nginx/sap-worker.conf:/etc/nginx/conf.d/sap-worker.conf
            - ./nginx/myplace-backend.conf:/etc/nginx/conf.d/myplace-backend.conf
            - ./nginx/cs-backend.conf:/etc/nginx/conf.d/cs-backend.conf
        ports:
          - "80:80"
    schuhedeserver:
        image: nginx:alpine
        container_name: schuhede-webserver
        volumes:
            - /home/stephen/qualibet:/var/www/html/qualibet
            - ./nginx/schuhede-api.conf:/etc/nginx/conf.d/schuhede-api.conf
        ports:
          - "88:80"
        expose:
          - "9900"
    php:
        build:
            context: ./php72
            args:
                - GITHUB_TOKEN=$GITHUB_TOKEN
        container_name: qualibet-php
        working_dir: /var/www/html/qualibet
        volumes:
            - /home/stephen/qualibet:/var/www/html/qualibet
            - ./php72/php-ini-overrides.ini:/usr/local/etc/php/conf.d/overrides.ini
            - ./php72/xdebug.ini:/usr/local/etc/php/conf.d/xdebug.ini
        expose:
          - "9000"
        environment:
              PHP_IDE_CONFIG: "serverName=docker"
              PHP_XDEBUG_ENABLED: 1
              XDEBUG_CONFIG: remote_enable=1 remote_port=9000 remote_autostart=1 remote_host=<ip of host machine> idekey=PHPSTORM
    elasticsearch1:
        image: docker.elastic.co/elasticsearch/elasticsearch:6.5.4
        container_name: elasticsearch1
        environment:
        - cluster.name=docker-cluster
        - bootstrap.memory_lock=true
        - "ES_JAVA_OPTS=-Xms1024m -Xmx1024m"
        ulimits:
        memlock:
            soft: -1
            hard: -1
        volumes:
        - esdata1:/home/siegl/elasticsearch/data
        ports:
        - 9200:9200
        networks:
        - esnet
    elasticsearch2:
        image: docker.elastic.co/elasticsearch/elasticsearch:6.5.4
        container_name: elasticsearch2
        environment:
        - cluster.name=docker-cluster
        - bootstrap.memory_lock=true
        - "ES_JAVA_OPTS=-Xms1024m -Xms1024m"
        - "discovery.zen.ping.unicast.hosts=elasticsearch"
        ulimits:
        memlock:
            soft: -1
            hard: -1
        volumes:
        - esdata2:/home/siegl/elasticsearch/data
        networks:
        - esnet
    kibana:
        image: docker.elastic.co/kibana/kibana:6.5.4
        container_name: kibana
        ports:
            - 5601:5601
        environment:
            SERVER_NAME: kibana
            ELASTICSEARCH_URL: http://elasticsearch1:9200
            XPACK_MONITORING_ENABLED: "false"
        networks:
            - esnet
volumes:
    esdata1:
        driver: local
    esdata2:
        driver: local

networks:
    esnet:

